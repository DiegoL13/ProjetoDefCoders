{% extends 'core/base.html' %}
{% load static %}
{% load core_tags %}

{% block title %}Cadastro de Paciente{% endblock %}

{% block extra_css %}
<style>
    /* Página de cadastro com design moderno seguindo padrão da home */
    .registration-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem 1rem 4rem;
    }
    
    .registration-header {
        text-align: center;
        margin-bottom: 3rem;
        padding: 3rem 2rem;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(224, 247, 255, 0.9) 100%);
        border-radius: 25px;
        box-shadow: 0 10px 30px rgba(0, 191, 255, 0.1);
        border: 1px solid rgba(0, 191, 255, 0.1);
        position: relative;
        overflow: hidden;
    }
    
    .registration-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--primary-dark));
    }
    
    .registration-header h1 {
        font-size: 2.8rem;
        color: var(--secondary);
        margin-bottom: 1rem;
        font-weight: 700;
        line-height: 1.2;
    }
    
    .registration-header .icon {
        color: var(--primary);
        font-size: 4rem;
        margin-bottom: 1.5rem;
        text-shadow: 0 4px 10px rgba(0, 191, 255, 0.2);
    }
    
    .registration-header p {
        color: var(--text-light);
        font-size: 1.2rem;
        max-width: 700px;
        margin: 0 auto;
        line-height: 1.6;
    }
    
    .form-container {
        background: var(--white);
        padding: 3rem;
        border-radius: 25px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
    }
    
    .form-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 5px;
        background: linear-gradient(90deg, var(--primary), var(--primary-dark));
    }
    
    .form-section {
        margin-bottom: 3rem;
        border-bottom: 2px solid var(--border);
        padding-bottom: 2.5rem;
        position: relative;
    }
    
    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .form-section-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
        color: var(--secondary);
        font-size: 1.5rem;
        font-weight: 700;
        padding: 1rem 1.5rem;
        background: linear-gradient(90deg, rgba(0, 191, 255, 0.05), transparent);
        border-radius: 15px;
        border-left: 4px solid var(--primary);
    }
    
    .form-section-header .icon {
        color: var(--primary);
        font-size: 1.8rem;
        background: rgba(0, 191, 255, 0.1);
        padding: 0.8rem;
        border-radius: 12px;
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 2rem;
    }
    
    .form-group {
        margin-bottom: 2rem;
        position: relative;
    }
    
    .form-group:focus-within .form-label {
        color: var(--primary);
    }
    
    .form-label {
        display: block;
        margin-bottom: 0.75rem;
        font-weight: 700;
        color: var(--secondary);
        font-size: 1rem;
        letter-spacing: 0.3px;
        transition: color 0.3s ease;
    }
    
    .form-label.required::after {
        content: " *";
        color: var(--danger);
        font-weight: 900;
    }
    
    .form-control {
        width: 100%;
        padding: 1rem 1.2rem;
        border: 2px solid var(--border);
        border-radius: 12px;
        font-size: 1.05rem;
        transition: all 0.3s ease;
        font-family: inherit;
        background: var(--white);
        color: var(--secondary);
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(0, 191, 255, 0.15);
        transform: translateY(-1px);
    }
    
    .form-control.is-invalid {
        border-color: var(--danger);
        background: rgba(231, 76, 60, 0.02);
    }
    
    .form-control::placeholder {
        color: #a0aec0;
        opacity: 0.7;
    }
    
    textarea.form-control {
        min-height: 140px;
        resize: vertical;
        line-height: 1.6;
    }
    
    .invalid-feedback {
        color: var(--danger);
        font-size: 0.875rem;
        margin-top: 0.5rem;
        display: block;
    }
    
    .help-text {
        color: var(--text-light);
        font-size: 0.9rem;
        margin-top: 0.6rem;
        display: block;
        line-height: 1.5;
        padding-left: 0.5rem;
        border-left: 3px solid var(--border);
    }
    
    .btn-register {
        background: var(--primary);
        color: var(--white);
        border: none;
        padding: 1.2rem 3rem;
        border-radius: 50px;
        font-weight: 700;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        box-shadow: 0 6px 20px rgba(0, 191, 255, 0.3);
        margin-top: 2rem;
        width: auto;
        min-width: 300px;
        justify-content: center;
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }
    
    .btn-register:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 191, 255, 0.4);
        background: var(--primary-dark);
    }
    
    .btn-register:active {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0, 191, 255, 0.3);
    }
    
    .auth-links {
        text-align: center;
        margin-top: 3rem;
        padding-top: 2.5rem;
        border-top: 2px solid var(--border);
    }
    
    .auth-links p {
        color: var(--text-light);
        margin-bottom: 1rem;
        font-size: 1.1rem;
    }
    
    .auth-links a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 700;
        transition: all 0.3s ease;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        display: inline-block;
    }
    
    .auth-links a:hover {
        background: rgba(0, 191, 255, 0.1);
        text-decoration: none;
        transform: translateY(-1px);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .registration-container {
            padding: 1.5rem 1rem 3rem;
        }
        
        .registration-header {
            padding: 2rem 1.5rem;
            margin-bottom: 2rem;
        }
        
        .registration-header h1 {
            font-size: 2.2rem;
        }
        
        .registration-header .icon {
            font-size: 3rem;
        }
        
        .registration-header p {
            font-size: 1.1rem;
        }
        
        .form-container {
            padding: 2rem;
        }
        
        .form-section-header {
            font-size: 1.3rem;
            padding: 0.8rem 1rem;
        }
        
        .btn-register {
            min-width: 250px;
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }
    }
    
    @media (max-width: 480px) {
        .registration-header h1 {
            font-size: 1.8rem;
        }
        
        .registration-header .icon {
            font-size: 2.5rem;
        }
        
        .form-container {
            padding: 1.5rem;
        }
        
        .form-section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .btn-register {
            width: 100%;
            min-width: unset;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="registration-container">
    <div class="registration-header">
        <div class="icon">
            <i class="fas fa-user-injured"></i>
        </div>
        <h1>Cadastro de Paciente</h1>
        <p>Preencha seus dados para acessar o Portal Saúde e acompanhar seus exames</p>
    </div>
    
    {% if messages %}
        {% for message in messages %}
            <div class="message message-{{ message.tags }}">
                <i class="fas fa-{{ message.tags|message_icon }}"></i>
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <div class="form-container">
        <form method="post" id="paciente-form">
            {% csrf_token %}
            
            <!-- Dados Pessoais -->
            <div class="form-section">
                <div class="form-section-header">
                    <i class="fas fa-user icon"></i>
                    <h3>Dados Pessoais</h3>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="{{ form.nome.id_for_label }}" class="form-label required">
                            Nome Completo
                        </label>
                        {{ form.nome|add_class:"form-control" }}
                        {% if form.nome.errors %}
                            <div class="invalid-feedback">{{ form.nome.errors|join:", " }}</div>
                        {% endif %}
                        <div class="help-text">Digite seu nome completo como aparece no documento</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_cpf" class="form-label required">
                            CPF
                        </label>
                        {{ form.cpf|add_class:"form-control" }}
                        {% if form.cpf.errors %}
                            <div class="invalid-feedback">{{ form.cpf.errors|join:", " }}</div>
                        {% endif %}
                        <div class="help-text">Apenas números, sem pontos ou traços</div>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="{{ form.data_nascimento.id_for_label }}" class="form-label required">
                            Data de Nascimento
                        </label>
                        {{ form.data_nascimento|add_class:"form-control" }}
                        {% if form.data_nascimento.errors %}
                            <div class="invalid-feedback">{{ form.data_nascimento.errors|join:", " }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.sexo.id_for_label }}" class="form-label required">
                            Sexo
                        </label>
                        {{ form.sexo|add_class:"form-control" }}
                        {% if form.sexo.errors %}
                            <div class="invalid-feedback">{{ form.sexo.errors|join:", " }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="{{ form.contato.id_for_label }}" class="form-label">
                            Telefone/WhatsApp
                        </label>
                        {{ form.contato|add_class:"form-control" }}
                        {% if form.contato.errors %}
                            <div class="invalid-feedback">{{ form.contato.errors|join:", " }}</div>
                        {% endif %}
                        <div class="help-text">(DDD) 99999-8888</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.email.id_for_label }}" class="form-label required">
                            E-mail
                        </label>
                        {{ form.email|add_class:"form-control" }}
                        {% if form.email.errors %}
                            <div class="invalid-feedback">{{ form.email.errors|join:", " }}</div>
                        {% endif %}
                        <div class="help-text">Será seu login para acesso ao sistema</div>
                    </div>
                </div>
            </div>
            
            <!-- Histórico Médico -->
            <div class="form-section">
                <div class="form-section-header">
                    <i class="fas fa-notes-medical icon"></i>
                    <h3>Histórico Médico</h3>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.historico_medico.id_for_label }}" class="form-label">
                        Histórico Médico (Opcional)
                    </label>
                    {{ form.historico_medico|add_class:"form-control" }}
                    {% if form.historico_medico.errors %}
                        <div class="invalid-feedback">{{ form.historico_medico.errors|join:", " }}</div>
                    {% endif %}
                    <div class="help-text">Doenças preexistentes, alergias, medicamentos em uso, etc.</div>
                </div>
            </div>
            
            <!-- Senha -->
            <div class="form-section">
                <div class="form-section-header">
                    <i class="fas fa-lock icon"></i>
                    <h3>Segurança</h3>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="id_password" class="form-label required">
                            Senha
                        </label>
                        {{ form.password|add_class:"form-control" }}
                        {% if form.password.errors %}
                            <div class="invalid-feedback">{{ form.password.errors|join:", " }}</div>
                        {% endif %}
                        <div class="help-text">Mínimo 6 caracteres</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm_password" class="form-label required">
                            Confirmar Senha
                        </label>
                        <input type="password" name="confirm_password" id="confirm_password" 
                               class="form-control" required placeholder="Digite a mesma senha">
                        <div class="help-text">Digite a senha novamente para confirmação</div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button type="submit" class="btn-register" id="submit-button">
                    <i class="fas fa-user-plus"></i>
                    <span id="button-text">Cadastrar Paciente</span>
                    <span id="button-spinner" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Processando...
                    </span>
                </button>
            </div>
        </form>
    </div>
    
    <div class="auth-links">
        <p>Já possui uma conta? <a href="/login/">Faça login</a></p>
        <p>É um médico? <a href="/cadastro/medico/">Cadastre-se aqui</a></p>
    </div>
</div>

<script>
// Validação de CPF
function validateCPF(cpf) {
    // Remover formatação e manter apenas números
    cpf = cpf.replace(/[^\d]/g, '');
    
    if (cpf.length !== 11) return false;
    if (/^(\d)\1{10}$/.test(cpf)) return false;
    
    let sum = 0;
    for (let i = 0; i < 9; i++) {
        sum += parseInt(cpf.charAt(i)) * (10 - i);
    }
    let remainder = 11 - (sum % 11);
    let digit1 = remainder >= 10 ? 0 : remainder;
    
    sum = 0;
    for (let i = 0; i < 10; i++) {
        sum += parseInt(cpf.charAt(i)) * (11 - i);
    }
    remainder = 11 - (sum % 11);
    let digit2 = remainder >= 10 ? 0 : remainder;
    
    return parseInt(cpf.charAt(9)) === digit1 && parseInt(cpf.charAt(10)) === digit2;
}

// Formatação de CPF
document.addEventListener('DOMContentLoaded', function() {
    const cpfField = document.getElementById('id_cpf');
    const form = document.getElementById('paciente-form');
    
    // Formatar CPF enquanto digita
    cpfField.addEventListener('input', function(e) {
        // Permitir apenas números, pontos e traço
        let value = e.target.value.replace(/[^\d.-]/g, '');
        
        // Remover formatação para processar apenas números
        let cleanValue = value.replace(/[^\d]/g, '');
        if (cleanValue.length > 11) {
            cleanValue = cleanValue.slice(0, 11);
        }
        
        // Aplicar formatação XXX.XXX.XXX-XX
        if (cleanValue.length > 9) {
            value = cleanValue.slice(0, 3) + '.' + cleanValue.slice(3, 6) + '.' + cleanValue.slice(6, 9) + '-' + cleanValue.slice(9);
        } else if (cleanValue.length > 6) {
            value = cleanValue.slice(0, 3) + '.' + cleanValue.slice(3, 6) + '.' + cleanValue.slice(6);
        } else if (cleanValue.length > 3) {
            value = cleanValue.slice(0, 3) + '.' + cleanValue.slice(3);
        } else {
            value = cleanValue;
        }
        
        e.target.value = value;
    });
    
    // Validação no submit
    form.addEventListener('submit', function(e) {
        const cpf = cpfField.value.replace(/[^\d]/g, '');
        const confirmPwd = document.getElementById('confirm_password').value;
        const pwd = document.getElementById('{{ form.password.id_for_label }}').value;
        
        // Validar CPF
        if (!validateCPF(cpf)) {
            e.preventDefault();
            cpfField.classList.add('is-invalid');
            
            let errorDiv = cpfField.parentNode.querySelector('.invalid-feedback');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback';
                errorDiv.textContent = 'CPF inválido';
                cpfField.parentNode.appendChild(errorDiv);
            }
            cpfField.focus();
            return false;
        }
        
        // Validar senhas
        if (pwd !== confirmPwd) {
            e.preventDefault();
            document.getElementById('confirm_password').classList.add('is-invalid');
            
            let errorDiv = document.getElementById('confirm_password').parentNode.querySelector('.invalid-feedback');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback';
                errorDiv.textContent = 'As senhas não conferem';
                document.getElementById('confirm_password').parentNode.appendChild(errorDiv);
            }
            document.getElementById('confirm_password').focus();
            return false;
        }
        
        // Mostrar spinner e desabilitar botão para evitar duplo envio
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const buttonSpinner = document.getElementById('button-spinner');
        
        submitButton.disabled = true;
        buttonText.style.display = 'none';
        buttonSpinner.style.display = 'inline';
        
        // Permitir envio do formulário
        return true;
    });
    
    // Limpar erros ao digitar
    cpfField.addEventListener('input', function() {
        this.classList.remove('is-invalid');
        const errorDiv = this.parentNode.querySelector('.invalid-feedback');
        if (errorDiv) errorDiv.remove();
    });
    
    document.getElementById('confirm_password').addEventListener('input', function() {
        this.classList.remove('is-invalid');
        const errorDiv = this.parentNode.querySelector('.invalid-feedback');
        if (errorDiv) errorDiv.remove();
    });
});
</script>
{% endblock %}