<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Exames do Paciente {{ paciente_id|default:0 }}</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:20px;background:#f7f9fb}
    .container{max-width:900px;margin:0 auto}
    .exame{background:#fff;border:1px solid #e3e8ee;padding:14px;margin:12px 0;border-radius:8px;box-shadow:0 1px 2px rgba(16,24,40,0.03)}
    .meta{color:#666;font-size:0.9em;margin-bottom:6px}
    .empty{color:#444;font-style:italic;padding:12px}
    .pager{display:flex;align-items:center;gap:8px;margin:14px 0;flex-wrap:wrap}
    .pager .pages{display:flex;gap:6px}
    .btn{background:#0b5fff;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
    .btn[disabled]{opacity:0.5;cursor:default}
    .page-btn{background:#fff;color:#0b5fff;border:1px solid #dbe7ff;padding:6px 9px;border-radius:6px;cursor:pointer}
    .page-btn.active{background:#0b5fff;color:#fff}
    .controls{margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
    .small{font-size:0.9em;color:#444}
  </style>
</head>
<body>
  <div class="container">
    <h1>Exames do Paciente {{ paciente_id|default:"?" }}</h1>
    <div class="controls">
      <div class="small">Paciente: <strong>{{ paciente_id|default:"?" }}</strong></div>
      <div>
        Mostrar
        <select id="pageSizeSelect">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="20">20</option>
        </select>
        por página
      </div>
    </div>

    <div id="loading">Carregando exames...</div>
    <div id="exames">
      {% if exames %}
        {% for exame in exames %}
          <div class="exame">
            <div><strong>{{ exame.tipo|default:"Exame" }}</strong></div>
            <div class="meta">{{ exame.data }}</div>
            <div>
              <div><strong>Resultado:</strong> {{ exame.resultado }}</div>
              <div><strong>Assinatura:</strong> {{ exame.assinatura }}</div>
              <div><strong>Médico:</strong> {{ exame.medico.nome }}{% if exame.medico.CRM %} (CRM: {{ exame.medico.CRM }}){% endif %}</div>
              <div><strong>Paciente:</strong> {{ exame.paciente.nome }}</div>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    <div class="pager" id="pager" style="display:none">
      <button class="btn" id="prevBtn">Anterior</button>
      <div class="pages" id="pages"></div>
      <button class="btn" id="nextBtn">Próximo</button>
    </div>
  </div>

  <script>
  (function(){
    const pacienteId = {{ paciente_id|default:0 }};
    const apiUrl = `/pacientes/${pacienteId}/exames/`;
    
    function renderField(key, value){
      return `<div><strong>${key}:</strong> ${value == null ? '' : String(value)}</div>`;
    }

    // client-side pagination
    let allExames = [];
    let currentPage = 1;
    let pageSize = parseInt(document.getElementById('pageSizeSelect').value, 10) || 10;

    function renderPage(){
      const container = document.getElementById('exames');
      container.innerHTML = '';
      if(!allExames || allExames.length === 0){
        container.innerHTML = '<div class="empty">Nenhum exame encontrado.</div>';
        document.getElementById('pager').style.display = 'none';
        return;
      }

      const total = allExames.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if(currentPage > totalPages) currentPage = totalPages;

      const start = (currentPage - 1) * pageSize;
      const pageItems = allExames.slice(start, start + pageSize);

      pageItems.forEach(exame => {
        const el = document.createElement('div');
        el.className = 'exame';
        const titulo = exame.tipo || (`Exame #${exame.id || ''}`);
        const meta = exame.data || '';
        el.innerHTML = `<div><strong>${titulo}</strong></div><div class="meta">${meta}</div>`;

        const fields = document.createElement('div');
        const resultado = exame.resultado || '';
        const assinatura = exame.assinatura || '';
        const medicoInfo = exame.medico ? ((exame.medico.nome || '') + (exame.medico.CRM ? ' (CRM: ' + exame.medico.CRM + ')' : '')) : '';
        const pacienteNome = exame.paciente ? (exame.paciente.nome || '') : '';

        fields.insertAdjacentHTML('beforeend', renderField('Resultado', resultado));
        fields.insertAdjacentHTML('beforeend', renderField('Assinatura', assinatura));
        fields.insertAdjacentHTML('beforeend', renderField('Médico', medicoInfo));
        fields.insertAdjacentHTML('beforeend', renderField('Paciente', pacienteNome));

        el.appendChild(fields);
        container.appendChild(el);
      });

      // pager
      const pager = document.getElementById('pager');
      const pagesEl = document.getElementById('pages');
      pagesEl.innerHTML = '';
      for(let i=1;i<=totalPages;i++){
        const b = document.createElement('button');
        b.className = 'page-btn' + (i===currentPage ? ' active' : '');
        b.textContent = i;
        b.addEventListener('click',()=>{ currentPage = i; renderPage(); });
        pagesEl.appendChild(b);
      }

      document.getElementById('prevBtn').disabled = currentPage <= 1;
      document.getElementById('nextBtn').disabled = currentPage >= totalPages;
      pager.style.display = totalPages > 1 ? 'flex' : 'none';
    }

    function setupControls(){
      document.getElementById('prevBtn').addEventListener('click',()=>{ if(currentPage>1){ currentPage--; renderPage(); } });
      document.getElementById('nextBtn').addEventListener('click',()=>{ const totalPages = Math.max(1, Math.ceil(allExames.length / pageSize)); if(currentPage<totalPages){ currentPage++; renderPage(); } });
      document.getElementById('pageSizeSelect').addEventListener('change',(e)=>{ pageSize = parseInt(e.target.value,10)||10; currentPage = 1; renderPage(); });
    }

    fetch(apiUrl)
      .then(res => { if(!res.ok) throw new Error(res.status + ' ' + res.statusText); return res.json(); })
      .then(data => {
        const loading = document.getElementById('loading');
        loading && loading.remove();
        allExames = Array.isArray(data) ? data : (data ? [data] : []);
        setupControls();
        renderPage();
      })
      .catch(err => {
        const loading = document.getElementById('loading');
        if(loading) loading.textContent = 'Erro ao carregar exames: ' + err.message;
      });
  })();
  </script>
</body>
</html>
