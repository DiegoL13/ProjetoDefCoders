{% extends 'core/base.html' %}
{% load static %}

{% block title %}Meus Exames{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        padding: 3rem 5%;
        background-color: var(--bg-light);
    }

    .dashboard-header {
        margin-bottom: 2.5rem;
    }

    .dashboard-header h1 {
        font-size: 2rem;
        color: var(--secondary);
        margin-bottom: 0.5rem;
    }

    /* Stats Cards */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
    }

    .stat-card {
        background: var(--white);
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        border-left: 5px solid var(--primary);
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .stat-card span {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-light);
        text-transform: uppercase;
    }

    .stat-card strong {
        font-size: 1.75rem;
        color: var(--secondary);
    }

    /* Exame Cards */
    .exames-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .exame-card {
        background: var(--white);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        border: 1px solid var(--border);
        transition: all 0.3s;
    }

    .exame-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.08);
    }

    .exame-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border);
    }

    .protocolo-info h3 {
        color: var(--primary);
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
    }

    .protocolo-info p {
        color: var(--text-light);
        font-size: 0.9rem;
    }

    .exame-body {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
    }

    .result-section h4 {
        font-size: 1.1rem;
        color: var(--secondary);
        margin-bottom: 1rem;
    }

    .result-badge {
        display: inline-block;
        padding: 0.5rem 1.5rem;
        background: #f0f9ff;
        color: var(--primary);
        border-radius: 10px;
        font-weight: 700;
        font-size: 1.1rem;
        border: 1px solid #e0f2fe;
    }

    .description {
        margin-top: 1rem;
        color: var(--secondary);
        line-height: 1.6;
    }

    .medico-info {
        background: #f8fafc;
        padding: 1.5rem;
        border-radius: 15px;
        border: 1px solid var(--border);
    }

    .medico-info h5 {
        font-size: 0.9rem;
        color: var(--text-light);
        text-transform: uppercase;
        margin-bottom: 0.5rem;
    }

    .medico-info p {
        font-weight: 600;
        color: var(--secondary);
        margin-bottom: 1rem;
    }

    .btn-download {
        width: 100%;
        padding: 0.8rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s;
    }

    .btn-download:hover {
        background: var(--primary-dark);
    }

    .empty-state {
        text-align: center;
        padding: 5rem;
        background: white;
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    .empty-state i {
        color: #cbd5e1;
        margin-bottom: 1.5rem;
    }

    /* Paginator */
    .pager {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin-top: 3rem;
    }

    .btn-pager {
        padding: 0.6rem 1.2rem;
        border-radius: 50px;
        border: 1px solid var(--border);
        background: white;
        color: var(--secondary);
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-pager:hover:not(:disabled) {
        border-color: var(--primary);
        color: var(--primary);
    }

    .btn-pager:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    @media (max-width: 768px) {
        .exame-body {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Olá, {{ user.nome }}</h1>
        <p style="color: var(--text-light);">Aqui está seu histórico completo de exames digitais.</p>
    </div>

    <div class="stats-row">
        <div class="stat-card">
            <span>Total de Exames</span>
            <strong id="totalExames">0</strong>
        </div>
        <div class="stat-card" style="border-left-color: var(--success);">
            <span>Última Atualização</span>
            <strong id="ultimaData">--/--/--</strong>
        </div>
    </div>

    <div id="loading" style="text-align: center; padding: 4rem;">
        <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--primary);"></i>
        <p style="margin-top: 1rem; color: var(--text-light);">Carregando seus resultados...</p>
    </div>

    <div id="exames-list" class="exames-list"></div>

    <div id="pager" class="pager" style="display: none;">
        <button class="btn-pager" id="prevBtn">Anterior</button>
        <span id="pageIndicator" style="font-weight: 600; color: var(--text-light);"></span>
        <button class="btn-pager" id="nextBtn">Próximo</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function(){
        const pacienteId = "{{ paciente_id }}";
        const apiUrl = `/pacientes/${pacienteId}/exames/`;
        
        let allExames = [];
        let currentPage = 1;
        let pageSize = 10;

        async function fetchExames() {
            try {
                const response = await fetch(apiUrl, {
                    headers: { 'Accept': 'application/json' }
                });
                const data = await response.json();
                allExames = Array.isArray(data) ? data : (data.results || []);
                renderPage();
            } catch (e) {
                console.error(e);
                renderPage();
            }
        }

        function renderPage() {
            const container = document.getElementById('exames-list');
            const loading = document.getElementById('loading');
            if (loading) loading.style.display = 'none';
            container.innerHTML = '';

            if (allExames.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-medical-alt fa-4x"></i>
                        <h3 style="color: var(--secondary); margin-bottom: 0.5rem;">Nenhum exame liberado</h3>
                        <p style="color: var(--text-light);">Quando seu médico liberar os resultados, eles aparecerão aqui.</p>
                    </div>`;
                return;
            }

            const start = (currentPage - 1) * pageSize;
            const pageItems = allExames.slice(start, start + pageSize);

            pageItems.forEach(exame => {
                const card = document.createElement('div');
                card.className = 'exame-card';
                card.innerHTML = `
                    <div class="exame-header">
                        <div class="protocolo-info">
                            <h3>Exame Digital</h3>
                            <p><i class="fas fa-hashtag"></i> Protocolo: ${exame.id}</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="color: var(--text-light); font-size: 0.9rem;">
                                <i class="far fa-calendar-alt"></i> ${new Date(exame.data_criacao).toLocaleDateString()}
                            </span>
                        </div>
                    </div>
                    <div class="exame-body">
                        <div class="result-info">
                            <h4>Resultado do Laudo</h4>
                            <div class="result-badge">${exame.resultado_medico || 'Análise Pendente'}</div>
                            <div class="description">
                                ${exame.descricao || 'Sem descrição detalhada disponível.'}
                            </div>
                        </div>
                        <div class="medico-section">
                            <div class="medico-info">
                                <h5>Médico Responsável</h5>
                                <p><i class="fas fa-user-md"></i> ${exame.medico_nome || 'Não identificado'}</p>
                                <button class="btn-download" onclick="window.print()">
                                    <i class="fas fa-file-pdf"></i> Visualizar PDF
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            updateStats();
            updatePager();
        }

        function updateStats() {
            document.getElementById('totalExames').textContent = allExames.length;
            if (allExames.length > 0) {
                const dates = allExames.map(e => new Date(e.data_criacao).getTime());
                document.getElementById('ultimaData').textContent = new Date(Math.max(...dates)).toLocaleDateString();
            }
        }

        function updatePager() {
            const totalPages = Math.ceil(allExames.length / pageSize);
            const pager = document.getElementById('pager');
            pager.style.display = totalPages > 1 ? 'flex' : 'none';
            if (totalPages > 1) {
                document.getElementById('pageIndicator').textContent = `${currentPage} / ${totalPages}`;
                document.getElementById('prevBtn').disabled = currentPage === 1;
                document.getElementById('nextBtn').disabled = currentPage === totalPages;
            }
        }

        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentPage > 1) { currentPage--; renderPage(); }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            const totalPages = Math.ceil(allExames.length / pageSize);
            if (currentPage < totalPages) { currentPage++; renderPage(); }
        });

        fetchExames();
    })();
</script>
{% endblock %}
